---
output:
  html_document: default
  pdf_document: default
---
```{r eval=FALSE, include=FALSE}
install.packages("rgbif")
```
```{r}
library(rgbif)
```



# Counting occurence records
```{r}
# occurence counts of GBIF data (all)
# Type of observations.
occ_count()
occ_count(basisOfRecord='OBSERVATION')
occ_count(basisOfRecord='HUMAN_OBSERVATION')
occ_count(basisOfRecord='MACHINE_OBSERVATION')
occ_count(basisOfRecord='LITERATURE')
occ_count(basisOfRecord='LIVING_SPECIMEN')
occ_count(basisOfRecord='FOSSIL_SPECIMEN')
```

```{r}
occ_count(georeferenced = TRUE)
```

Records for Ragweed.
```{r}
# Ragweed (Genus:Ambrosia) is 3110576.
occ_count(taxonKey=3110576)
```

All records from 2012
```{r}
occ_count(year = 2012)
```

```{r}
# Ragweed (Genus:Ambrosia, taxonKey= 3110576).
# By human observation
# In United States (country code = US)
# Has long/lat data
occ_count(basisOfRecord='HUMAN_OBSERVATION', country = "US", taxonKey=3110588, georeferenced = TRUE)
```

acceptable set
```
• basisOfRecord, country
• basisOfRecord, country, isGeoreferenced
• basisOfRecord, country, isGeoreferenced, taxonKey
• basisOfRecord, country, taxonKey
• basisOfRecord, datasetKey
• basisOfRecord, datasetKey, isGeoreferenced
• basisOfRecord, datasetKey, isGeoreferenced, taxonKey
• basisOfRecord, datasetKey, taxonKey
• basisOfRecord, isGeoreferenced, taxonKey
• basisOfRecord, isGeoreferenced, publishingCountry
• basisOfRecord, isGeoreferenced, publishingCountry, taxonKey
• basisOfRecord, publishingCountry
• basisOfRecord, publishingCountry, taxonKey
• basisOfRecord, taxonKey
• country
• country, datasetKey, isGeoreferenced
• country, isGeoreferenced
• country, isGeoreferenced, publishingCountry
• country, isGeoreferenced, taxonKey
• country, publishingCountry
• country, taxonKey
• country, typeStatus
• datasetKey
• datasetKey, isGeoreferenced
• datasetKey, isGeoreferenced, taxonKey
• datasetKey, issue
• datasetKey, taxonKey
• datasetKey, typeStatus
• isGeoreferenced
• isGeoreferenced, publishingCountry
• isGeoreferenced, publishingCountry, taxonKey
• isGeoreferenced, taxonKey
• issue
• publishingCountry
• publishingCountry, taxonKey
• publishingCountry, typeStatus
• taxonKey
• taxonKey, typeStatus
• typeStatus
• protocol
• year
```
---------------------------------------------------------------------
? facetted count?
dataset usage??
```{r}
spplist <- c('Geothlypis trichas','Tiaris olivacea','Pterodroma axillaris','Calidris ferruginea','Pterodroma macroptera',
'Gallirallus australis','Falco cenchroides','Telespiza cantans','Oreomystis bairdi','Cistothorus palustris')
keys <- sapply(spplist, function(x) name_backbone(x, rank="species")$usageKey)
count_facet(keys, by='country', countries=3, removezeros = TRUE)
```
```{r}
dataset_suggest(query="Amazon", type="OCCURRENCE")
```
```{r}
isocodes[agrep("UNITED", isocodes$gbif_name),]
dataset_suggest(country="US", limit = 25)
```









---------------------------------------------------------------------
# get a citation info for dataset or occurence data.
```{r}
res1 <- occ_search(taxonKey=9206251, limit=2)
xx <- gbif_citation(res1)
xx[[2]]$citation$text
```
```{r}
res3 <- occ_search(taxonKey=9206251, fields=c('name','basisOfRecord','key'),limit=5)
xx <- gbif_citation(res3)
xx[[2]]$citation$text
```

----------------------------------------------------------------------
# how to get taxon key.
Why is the usageKey and taxonKey are different? === synonim problem!!
```{r}
name_backbone(name='Ambrosia', rank = "genus")$genusKey
name_backbone(name='Ambrosia aptera', rank = "species")$speciesKey
```

# How to get country code
```{r}
# Country codes are stored in isocodes.csv.
head(isocodes)
```

E.g. occurence records of ragweed in USA.
```{r}
key <- name_backbone(name = 'Ambrosia aptera', rank = "species")$speciesKey
usa_code <- isocodes[grep("^United States$", isocodes$name), "code"]
occ_count(basisOfRecord = 'HUMAN_OBSERVATION', taxonKey = key, country = usa_code, georeferenced = TRUE)
```

-----------------------------------------------------------------------------------
# If you seach for infomation about specific taxon.
```{r}
spdata <- name_lookup(query="Ambrosia", rank="genus", return="data")
head(spdata)
```
```{r}
res <- name_lookup(query='canada', hl=TRUE, limit=5)
gbif_names(res)
```
# name viewer gbif_names
```{r}
occsrc_Ursus <- name_lookup(query="Ursus americanus", limit=20)
gbif_names(occsrc_Ursus)
```




```
taxonkey <- spdata[1, "nubKey"]
taxonkey
```

```{r}
spdata2 <- name_usage(name = "Ambrosia", rank = "genus", return = "data")
head(spdata2)
```

If you are unsure about taxonomic names and their keys.
```{r}
name_suggest(q='Plasmodium', rank = "genus")
```
```{r}
name_suggest(q='Ambrosia')
```


```{r}
spbkbn <- name_backbone(name='Ambrosia', kingdom='plants')
spbkbn
```

# If you are unsure about what kind of taxonomic rank can be used.
```{r}
taxrank()
```

------------------------------------------------------------------------------------
# Search for occurence data in sp level. 
Note that hasCoordinate in occ_search() is the same as georeferenced in occ_count()
```{r}
key <- name_backbone(name='Ambrosia aptera')$speciesKey
spdat <- occ_search(taxonKey=key, return='data', limit=300)
```
Search for occurence data of all species in the specified genus. 
```{r}
gendat <- occ_search(taxonKey=3110576, return='data', limit=300)
```

search for specific taxa
```{r}
occ_search(scientificName = "Ursus americanus", limit = 20)
```

accept many values by using c().
```{r}
manyvalue_test <- occ_search(scientificName = c("Ursus americanus", "Ambrosia aptera"), return = "data")
# output will be a list.
head(manyvalue_test[1])
head(manyvalue_test[2])
```


-------------------------------------------------------------------
# browse photos
```{r}
res <- occ_search(taxonKey=3110576, mediaType = 'StillImage', return = "media")
gbif_photos(res, output = "./", which='table')
```




---------------------------------------------------------------------
# country&taxonkey
```{r}
key <- name_backbone(name='Ambrosia aptera')$speciesKey
usa_code <- isocodes[grep("^United States$", isocodes$name), "code"]
gendat <- occ_search(taxonKey=key, country=usa_code, return='data', limit=300)
```


Cynodon dactylon
```{r}
name_backbone(name='Cynodon dactylon')$speciesKey
```

-----------------------------------------------------------------------------------------
# Plot on map
```{r}
library(ggplot2)
library(maps)
```

```{r}
# Example: Bermuda grass.
occ_Bmdgrs <- occ_search(taxonKey=6109637, hasCoordinate = TRUE, return='data')
world <- map_data("world")
ggplot(world, aes(long, lat)) +
ggtitle("Bermuda grass") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = occ_Bmdgrs,
aes(decimalLongitude, decimalLatitude), alpha=0.6, 
             size = 1.5, color = "red", show.legend = TRUE)
```
```{r}
# Example: ragweed.
occ_ragweed <- occ_search(taxonKey=3110576, country = "US", return='data')
world <- map_data("usa")
ggplot(world, aes(long, lat)) +
ggtitle("Ragweed") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = occ_ragweed,
aes(decimalLongitude, decimalLatitude), alpha=0.6, 
             size = 2, color = "red")
```


Use mapr map_ggplot. This works!
```{r}
library(mapr)
```
Example: Bermuda grass
```{r}
# usa.
occ_bmdgrs <- occ_search(taxonKey=6109637, country = "US", hasCoordinate=TRUE)
map_ggplot(occ_bmdgrs, map = "usa", size = 2)
```
Example: Ragweed
```{r}
# usa.
occ_ragweed <- occ_search(taxonKey=3110576, country = "US", hasCoordinate=TRUE)
map_ggplot(occ_ragweed, map = "usa", size = 2)
```
```{r}
# world.
occ_ragweed <- occ_search(taxonKey=3110576, hasCoordinate=TRUE)
map_ggplot(occ_ragweed, map = "world", size = 2)
```



map_fetch doesn't work well.
```{r}
x <- map_fetch(source = "density", format = "@1x.png", srs = "EPSG:3857", bin = "hex", hexPerTile = 1, params = (taxonKey = 3110576, country = "US"))
plot(x)
```

-------------------------------------------------------------------------
```{r}
## Not run:
if (
requireNamespace("png", quietly = TRUE) &&
requireNamespace("raster", quietly = TRUE)
) {
x <- map_fetch(taxonKey = 3110576)
x
# gives a RasterLayer object
class(x)
# visualize
library(raster)
plot(x)
# different srs
## 3857
y <- map_fetch(taxonKey = 3110576, srs = "EPSG:3857")
plot(y)
## 3031
z <- map_fetch(taxonKey = 3110576, srs = "EPSG:3031", verbose = TRUE)
plot(z)
# 3575
z <- map_fetch(taxonKey = 3110576, srs = "EPSG:3575")
plot(z)
# bin
plot(map_fetch(taxonKey = 3110576, bin = "hex",
hexPerTile = 30, style = "classic-noborder.poly"))
# styles
plot(map_fetch(taxonKey = 3110576, style = "purpleYellow.point"))
# query with basisOfRecord
map_fetch(taxonKey = 3110576, basisOfRecord = "HUMAN_OBSERVATION")
map_fetch(taxonKey = 3110576, basisOfRecord = c("HUMAN_OBSERVATION", "LIVING_SPECIMEN"))
}
## End(Not run)
```






-----------------------------------------------------------------------------------
name_suggest() is optimized for speed, and gives back suggested names based on query parameters.
```{r}
head(name_suggest(q='Puma concolor'))
```

------------------------------------------------------------------------------------

multiple occurences
```{r}
occ_get(key=c(101010, 240713150, 855998194), return='data')
```

???what's datasetkey???
```{r}
occ_count(datasetKey='9e7ea106-0bf8-4087-bb61-dfe4f29e0f17')
```