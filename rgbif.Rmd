---
output:
  html_document: default
  pdf_document: default
---
```{r eval=FALSE, include=FALSE}
install.packages("rgbif")
install.packages("mapr")
```
```{r}
library(rgbif)
```



# Counting occurence records
```{r}
# occurence counts of GBIF data (all)
# Type of observations.
occ_count()
occ_count(basisOfRecord='OBSERVATION')
occ_count(basisOfRecord='HUMAN_OBSERVATION')
occ_count(basisOfRecord='MACHINE_OBSERVATION')
occ_count(basisOfRecord='LITERATURE')
occ_count(basisOfRecord='LIVING_SPECIMEN')
occ_count(basisOfRecord='FOSSIL_SPECIMEN')
```

```{r}
occ_count(georeferenced = TRUE)
```

Records for Ragweed.
```{r}
# Ragweed (Genus:Ambrosia) is 3110576.
occ_count(taxonKey=3110576)
```

All records from 2012
```{r}
occ_count(year = 2012)
```

```{r}
# Ragweed (Genus:Ambrosia, taxonKey= 3110576).
# By human observation
# In United States (country code = US)
# Has long/lat data
occ_count(basisOfRecord='HUMAN_OBSERVATION', country = "US", taxonKey=3110588, georeferenced = TRUE)
```

acceptable set
```
• basisOfRecord, country
• basisOfRecord, country, isGeoreferenced
• basisOfRecord, country, isGeoreferenced, taxonKey
• basisOfRecord, country, taxonKey
• basisOfRecord, datasetKey
• basisOfRecord, datasetKey, isGeoreferenced
• basisOfRecord, datasetKey, isGeoreferenced, taxonKey
• basisOfRecord, datasetKey, taxonKey
• basisOfRecord, isGeoreferenced, taxonKey
• basisOfRecord, isGeoreferenced, publishingCountry
• basisOfRecord, isGeoreferenced, publishingCountry, taxonKey
• basisOfRecord, publishingCountry
• basisOfRecord, publishingCountry, taxonKey
• basisOfRecord, taxonKey
• country
• country, datasetKey, isGeoreferenced
• country, isGeoreferenced
• country, isGeoreferenced, publishingCountry
• country, isGeoreferenced, taxonKey
• country, publishingCountry
• country, taxonKey
• country, typeStatus
• datasetKey
• datasetKey, isGeoreferenced
• datasetKey, isGeoreferenced, taxonKey
• datasetKey, issue
• datasetKey, taxonKey
• datasetKey, typeStatus
• isGeoreferenced
• isGeoreferenced, publishingCountry
• isGeoreferenced, publishingCountry, taxonKey
• isGeoreferenced, taxonKey
• issue
• publishingCountry
• publishingCountry, taxonKey
• publishingCountry, typeStatus
• taxonKey
• taxonKey, typeStatus
• typeStatus
• protocol
• year
```
---------------------------------------------------------------------
? facetted count?
dataset usage??
```{r}
spplist <- c('Geothlypis trichas','Tiaris olivacea','Pterodroma axillaris','Calidris ferruginea','Pterodroma macroptera',
'Gallirallus australis','Falco cenchroides','Telespiza cantans','Oreomystis bairdi','Cistothorus palustris')
keys <- sapply(spplist, function(x) name_backbone(x, rank="species")$usageKey)
count_facet(keys, by='country', countries=3, removezeros = TRUE)
```
```{r}
dataset_suggest(query="Amazon", type="OCCURRENCE")
```
```{r}
isocodes[agrep("UNITED", isocodes$gbif_name),]
dataset_suggest(country="US", limit = 25)
```









---------------------------------------------------------------------
# get a citation info for dataset or occurence data.
```{r}
res1 <- occ_search(taxonKey=9206251, limit=2)
xx <- gbif_citation(res1)
xx[[2]]$citation$text
```
```{r}
res3 <- occ_search(taxonKey=9206251, fields=c('name','basisOfRecord','key'),limit=5)
xx <- gbif_citation(res3)
xx[[2]]$citation$text
```

----------------------------------------------------------------------
# how to get taxon key.
Why is the usageKey and taxonKey are different? === synonim problem!!
```{r}
name_backbone(name='Ambrosia', rank = "genus")$genusKey
name_backbone(name='Ambrosia aptera', rank = "species")$speciesKey
```

# How to get country code
```{r}
# Country codes are stored in isocodes.csv.
head(isocodes)
```

E.g. occurence records of ragweed in USA.
```{r}
key <- name_backbone(name = 'Ambrosia aptera', rank = "species")$speciesKey
usa_code <- isocodes[grep("^United States$", isocodes$name), "code"]
occ_count(basisOfRecord = 'HUMAN_OBSERVATION', taxonKey = key, country = usa_code, georeferenced = TRUE)
```

-----------------------------------------------------------------------------------
# If you seach for infomation about specific taxon.
```{r}
spdata <- name_lookup(query="Ambrosia", rank="genus", return="data")
head(spdata)
```
```{r}
res <- name_lookup(query='canada', hl=TRUE, limit=5)
gbif_names(res)
```
# name viewer gbif_names
```{r}
occsrc_Ursus <- name_lookup(query="Ursus americanus", limit=20)
gbif_names(occsrc_Ursus)
```




```
taxonkey <- spdata[1, "nubKey"]
taxonkey
```

```{r}
spdata2 <- name_usage(name = "Ambrosia", rank = "genus", return = "data")
head(spdata2)
```

If you are unsure about taxonomic names and their keys.
```{r}
name_suggest(q='Plasmodium', rank = "genus")
```
```{r}
name_suggest(q='Ambrosia')
```


```{r}
spbkbn <- name_backbone(name='Ambrosia', kingdom='plants')
spbkbn
```

# If you are unsure about what kind of taxonomic rank can be used.
```{r}
taxrank()
```

------------------------------------------------------------------------------------
# Search for occurence data in sp level. 
Note that hasCoordinate in occ_search() is the same as georeferenced in occ_count()
```{r}
key <- name_backbone(name='Ambrosia aptera')$speciesKey
spdat <- occ_search(taxonKey=key, return='data', limit=300)
```
Search for occurence data of all species in the specified genus. 
```{r}
gendat <- occ_search(taxonKey=3110576, return='data', limit=300)
```

search for specific taxa
```{r}
occ_search(scientificName = "Ursus americanus", limit = 20)
```

accept many values by using c().
```{r}
manyvalue_test <- occ_search(scientificName = c("Ursus americanus", "Ambrosia aptera"), return = "data")
# output will be a list.
head(manyvalue_test[1])
head(manyvalue_test[2])
```


-------------------------------------------------------------------
# browse photos
```
res <- occ_search(taxonKey=3110576, mediaType = 'StillImage', return = "media")
gbif_photos(res, output = "./", which='table')
```




---------------------------------------------------------------------
# country&taxonkey
```{r}
key <- name_backbone(name='Ambrosia aptera')$speciesKey
usa_code <- isocodes[grep("^United States$", isocodes$name), "code"]
gendat <- occ_search(taxonKey=key, country=usa_code, return='data', limit=300)
```


Cynodon dactylon
```{r}
name_backbone(name='Cynodon dactylon')$speciesKey
```







-----------------------------------------------------------------------------------
name_suggest() is optimized for speed, and gives back suggested names based on query parameters.
```{r}
head(name_suggest(q='Puma concolor'))
```

------------------------------------------------------------------------------------

multiple occurences
```{r}
occ_get(key=c(101010, 240713150, 855998194), return='data')
```

???what's datasetkey???
```{r}
occ_count(datasetKey='9e7ea106-0bf8-4087-bb61-dfe4f29e0f17')
```

--------------------------------------------------------------------------------------------
# Download occurence data >500

Set user name, passward, email as object.
```{r}
user <- "namiko"
pwd <- "735seibutsu"
email <- "nm0076@mix.wvu.edu"
```

Prepare for download
# DWCA: Darwin Core Archive
```{r}
#Ambrosia aptera:3110588
#country:USA
dl_DWCA <- occ_download('taxonKey = 3110588', 'country = US', format = "DWCA", user = user, pwd = pwd, email = email)
dl_DWCA
```
Wait for 15 min!?
Save file to your computer.
```{r}
# key: "0007911-191105090559680"
# File 413 KB Simple
# Involved datasets 84
# Occurrences 5,695
occ_download_get(key = dl_DWCA, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
# Import
res <- occ_download_get(key = "0007911-191105090559680", path = "./", overwrite=TRUE)
DWCA_data <- occ_download_import(res)
# 237 columns!
# specify columns and extract them
newdata <- DWCA_data[,c("taxonID", "scientificNameID", "kingdom", "phylum", "class", "order", "family", "genus", "subgenus", "specificEpithet", "decimalLatitude", "decimalLongitude", "year", "continent", "county", "georeferenceProtocol", "georeferenceSources", "georeferenceVerificationStatus", "georeferenceRemarks")]
newdata <- newdata[!is.na(newdata$decimalLatitude),]
# plot the data by using ggplot.
usa <- map_data("usa")
ggplot(usa, aes(long, lat)) +
ggtitle("Ambrosia aptera in USA") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = newdata, aes(decimalLongitude, decimalLatitude), alpha=0.6, size = 2, show.legend = TRUE, color = "red")
```

# Download Ambrosia genus (TEMPLATE!)
plot by species
```{r}
#Ambrosia:3110576 as genus
#country:USA
Ambrosia_usa_DWCA <- occ_download('taxonKey = 3110576', 'country = US', format = "DWCA", user = user, pwd = pwd, email = email)
Ambrosia_usa_DWCA
```
```{r}
# key: "0007972-191105090559680"
# File 413 KB Simple
# Involved datasets 84
# Occurrences 30,007
res <- occ_download_get(key = Ambrosia_usa_DWCA, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
Ambrosia_usa_data <- occ_download_import(res)

Ambrosia_usa_data_col <- Ambrosia_usa_data[,c("taxonID", "scientificNameID", "kingdom", "phylum", "class", "order", "family", "genus", "subgenus", "specificEpithet", "decimalLatitude", "decimalLongitude", "year", "continent", "county", "georeferenceProtocol", "georeferenceSources", "georeferenceVerificationStatus", "georeferenceRemarks")]
Ambrosia_usa_data_col <- Ambrosia_usa_data_col[!is.na(Ambrosia_usa_data_col$decimalLatitude),]

usa <- map_data("usa")
ggplot(usa, aes(long, lat)) +
ggtitle("Species distribution of ragweed (genus Ambrosia)") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = Ambrosia_usa_data_col, aes(decimalLongitude, decimalLatitude, color = specificEpithet), alpha=1, size = 1, show.legend = TRUE) +
coord_map(xlim = c(-130, -60), ylim = c(20, 50)) +
theme(legend.position="bottom", legend.box = "horizontal", legend.text  = element_text(size = 7), legend.key.size = unit(0.1, "lines"))
```

# Download Zika virus (TEMPLATE!)
plot by year
```{r}
#Zika virus: 9848767 as genus Flavivirus
ZikaVirus_DWCA <- occ_download('taxonKey = 9848767', format = "DWCA", user = user, pwd = pwd, email = email)
ZikaVirus_DWCA
```
```{r}
# key: "0007974-191105090559680"
# File 413 KB Simple
# Involved datasets 84
# Occurrences 30,007
res <- occ_download_get(key = ZikaVirus_DWCA, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
ZikaVirus_data <- occ_download_import(res)

ZikaVirus_data_col <- ZikaVirus_data[,c("taxonID", "scientificNameID", "kingdom", "phylum", "class", "order", "family", "genus", "subgenus", "specificEpithet", "decimalLatitude", "decimalLongitude", "year", "continent", "county", "georeferenceProtocol", "georeferenceSources", "georeferenceVerificationStatus", "georeferenceRemarks")]
ZikaVirus_data_col <- ZikaVirus_data_col[!is.na(ZikaVirus_data_col$decimalLatitude),]

world <- map_data("world")
ggplot(world, aes(long, lat)) +
ggtitle("Spread of Zika virus -2019") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = ZikaVirus_data_col, aes(decimalLongitude, decimalLatitude, color = year), alpha=1, size = 3, show.legend = TRUE) +
scale_color_gradient(name="Year", low="blue", high="red")
```




-----------------------------------------------------------------------------------------
# Plot on map
```{r}
library(ggplot2)
library(maps)
```

```{r}
# Example: Bermuda grass.
occ_Bmdgrs <- occ_search(taxonKey=6109637, hasCoordinate = TRUE, return='data')
world <- map_data("world")
ggplot(world, aes(long, lat)) +
ggtitle("Bermuda grass") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = occ_Bmdgrs,
aes(decimalLongitude, decimalLatitude), alpha=0.6, 
             size = 1.5, color = "red", show.legend = TRUE)
```
```{r}
# Example: ragweed.
occ_ragweed <- occ_search(taxonKey=3110588, country = "US", return='data')
world <- map_data("usa")
ggplot(world, aes(long, lat)) +
ggtitle("Ragweed") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = occ_ragweed,
aes(decimalLongitude, decimalLatitude), alpha=0.6, 
             size = 2, color = "red")
```

```{r}
# Example: Zika virus.
occ_Zika <- occ_search(scientificName = "Flavivirus", hasCoordinate = TRUE, return='data')
world <- map_data("world")
ggplot(world, aes(long, lat)) +
ggtitle("Spread of Zika virus -2019") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = occ_Zika, aes(decimalLongitude, decimalLatitude, color = year), alpha=0.6, size = 3, show.legend = TRUE) +
scale_color_gradient(name="Year", low="blue", high="red2")
```


Use mapr map_ggplot. This works!
```{r}
library(mapr)
```
Example: Bermuda grass
```{r}
# usa.
occ_bmdgrs <- occ_search(taxonKey=6109637, country = "US", hasCoordinate=TRUE)
map_ggplot(occ_bmdgrs, map = "usa", size = 2)
```
Example: Ragweed
```{r}
# usa.
occ_ragweed <- occ_search(taxonKey=3110576, country = "US", hasCoordinate=TRUE)
map_ggplot(occ_ragweed, map = "usa", size = 2)
```
```{r}
# world.
occ_ragweed <- occ_search(taxonKey=3110576, hasCoordinate=TRUE)
map_ggplot(occ_ragweed, map = "world", size = 2)
```



map_fetch doesn't work well.
```{r}
x <- map_fetch(source = "density", format = "@1x.png", srs = "EPSG:3857", bin = "hex", hexPerTile = 1, params = (taxonKey = 3110576, country = "US"))
plot(x)
```

-------------------------------------------------------------------------
```{r}
## Not run:
if (
requireNamespace("png", quietly = TRUE) &&
requireNamespace("raster", quietly = TRUE)
) {
x <- map_fetch(taxonKey = 3110576)
x
# gives a RasterLayer object
class(x)
# visualize
library(raster)
plot(x)
# different srs
## 3857
y <- map_fetch(taxonKey = 3110576, srs = "EPSG:3857")
plot(y)
## 3031
z <- map_fetch(taxonKey = 3110576, srs = "EPSG:3031", verbose = TRUE)
plot(z)
# 3575
z <- map_fetch(taxonKey = 3110576, srs = "EPSG:3575")
plot(z)
# bin
plot(map_fetch(taxonKey = 3110576, bin = "hex",
hexPerTile = 30, style = "classic-noborder.poly"))
# styles
plot(map_fetch(taxonKey = 3110576, style = "purpleYellow.point"))
# query with basisOfRecord
map_fetch(taxonKey = 3110576, basisOfRecord = "HUMAN_OBSERVATION")
map_fetch(taxonKey = 3110576, basisOfRecord = c("HUMAN_OBSERVATION", "LIVING_SPECIMEN"))
}
## End(Not run)
```




























--------------------------------------------------------------------------------------------
# download experiment
```{r}
user <- "namiko"
pwd <- "735seibutsu"
email <- "nm0076@mix.wvu.edu"
```

Prepare for download.
simple_csv:X
SPECIES_LIST:X no coordinate
DWCA: works!
# DWCA
```{r}
#Ambrosia aptera:3110588L
#DWCA
dl_DWCA <- occ_download('taxonKey = 3110588', 'country = US', format = "DWCA", user = user, pwd = pwd, email = email)
dl_DWCA
```
Wait for 15 min!?
Save file to your computer.
```{r}
# key: "0007911-191105090559680"
# File 413 KB Simple
# Involved datasets 84
# Occurrences 5,695
occ_download_get(key = dl_DWCA, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
```
Import
```{r}
res <- occ_download_get(key = dl_DWCA, path = "./", overwrite=TRUE)
DWCA_data <- occ_download_import(res)
```
237 columns!
lat.long.data decimalLatitude, decimalLongitude
specify columns and extract them?


# SPECIES_LIST
```{r}
#Ambrosia aptera:3110588L
#SPECIES_LIST
dl_SPECIES_LIST <- occ_download('taxonKey = 3110588', 'country = US', format = "SPECIES_LIST", user = user, pwd = pwd, email = email)
dl_SPECIES_LIST
```
Wait for 15 min!?
Save file to your computer.
```{r}
# key: "0007912-191105090559680"
# File 413 KB Simple
# Involved datasets 84
# Occurrences 5,695
occ_download_get(key = dl_SPECIES_LIST, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
```
Import?
```{r}
res <- occ_download_get(key = dl_SPECIES_LIST, path = "./", overwrite=TRUE)
SPECIES_LIST_data <- occ_download_import(res)
SPECIES_LIST_data
```
