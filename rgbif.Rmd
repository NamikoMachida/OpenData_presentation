---
output:
  html_document: default
  pdf_document: default
---
# rgbif
## GBIF *the Global Biodiversity Information Facility*

an open access biodiversity database in the world
intergovermantal
97 countries, over 1500 publishers (mainly universities, museums, scientific institutions)

contributers: goverments, scientific institutions

funded by voting countries

since 2001
more than a billion records
----------------------------------------------------------

### Instal rgbif
```{r eval=FALSE, include=FALSE}
install.packages("rgbif")
```
```{r}
library(rgbif)
```

--------------------------------------------------------------------
### What can be done with rgbif?
You will have open access to more than a billion occurence records of biodiversity data over the world.

#### 1. Count occurence records
Count by observation types.
```{r}
occ_count(basisOfRecord='OBSERVATION')
occ_count(basisOfRecord='HUMAN_OBSERVATION')
occ_count(basisOfRecord='MACHINE_OBSERVATION')
occ_count(basisOfRecord='LITERATURE')
occ_count(basisOfRecord='LIVING_SPECIMEN')
occ_count(basisOfRecord='FOSSIL_SPECIMEN')
```
Count data that have lat/long data.
```{r}
occ_count(georeferenced = TRUE)
```
Count data for specific year.
```{r}
occ_count(year = 2012)
```
Count for specific taxonomic group.
```{r}
# Occurence of ragweed: Genus Ambrosia, taxonkey = 3110576
occ_count(taxonKey=3110576)
```

Combine multiple serch conditions.
E.g. occurence records of ragweed in USA.
```{r}
# Observation type: Human Observation
# Country: United States (country code = US)
# Taxon: Ambrosia (taxonKey= 3110576)
# Has long/lat data
occ_count(basisOfRecord='HUMAN_OBSERVATION', country = "US", taxonKey=3110588, georeferenced = TRUE)
```
Acceptable set of search conditions.

• basisOfRecord, country
• basisOfRecord, country, isGeoreferenced
• basisOfRecord, country, isGeoreferenced, taxonKey
• basisOfRecord, country, taxonKey
• basisOfRecord, datasetKey
• basisOfRecord, datasetKey, isGeoreferenced
• basisOfRecord, datasetKey, isGeoreferenced, taxonKey
• basisOfRecord, datasetKey, taxonKey
• basisOfRecord, isGeoreferenced, taxonKey
• basisOfRecord, isGeoreferenced, publishingCountry
• basisOfRecord, isGeoreferenced, publishingCountry, taxonKey
• basisOfRecord, publishingCountry
• basisOfRecord, publishingCountry, taxonKey
• basisOfRecord, taxonKey
• country
• country, datasetKey, isGeoreferenced
• country, isGeoreferenced
• country, isGeoreferenced, publishingCountry
• country, isGeoreferenced, taxonKey
• country, publishingCountry
• country, taxonKey
• country, typeStatus
• datasetKey
• datasetKey, isGeoreferenced
• datasetKey, isGeoreferenced, taxonKey
• datasetKey, issue
• datasetKey, taxonKey
• datasetKey, typeStatus
• isGeoreferenced
• isGeoreferenced, publishingCountry
• isGeoreferenced, publishingCountry, taxonKey
• isGeoreferenced, taxonKey
• issue
• publishingCountry
• publishingCountry, taxonKey
• publishingCountry, typeStatus
• taxonKey
• taxonKey, typeStatus
• typeStatus
• protocol
• year


#### How to get *taxonkey*?
Taxon key can be obtained from taxonomic search using
```{r}
name_backbone(name='Ambrosia', rank = "genus")$genusKey
name_backbone(name='Ambrosia aptera', rank = "species")$speciesKey
```

If you are unsure about taxonomic names and usages in GBIF system, you can search for taxonomic names with partial input. 
```{r}
sugggest <- name_suggest(q='Ambros')
head(sugggest)
```
You can confine output result within specific taxonomic rank.
```{r}
suggest_sp <- name_suggest(q='Ambrosia', rank = "species")
head(suggest_sp)
```

?? how the name is used in gbif??
```{r}
usage <- name_usage(name = "Ambrosia intergradiens", return = "data")
head(usage)
```


#### How to get *country code*?
Country codes are stored in isocodes.csv, that comes with rgbif package.
```{r}
head(isocodes)
```
```{r}
# country code of United States.
isocodes[grep("^United States$", isocodes$name), "code"]
```



#### Search for occurence records
occ_search (LIMIT 500)(suitable for small scale serach)

# Usage
occ_search(taxonKey = NULL, scientificName = NULL, country = NULL, publishingCountry = NULL, hasCoordinate = NULL, typeStatus = NULL, recordNumber = NULL, lastInterpreted = NULL, continent = NULL, geometry = NULL, geom_big = "asis", geom_size = 40, geom_n = 10, recordedBy = NULL, basisOfRecord = NULL, datasetKey = NULL, eventDate = NULL, catalogNumber = NULL, year = NULL, month = NULL, decimalLatitude = NULL, decimalLongitude = NULL, elevation = NULL, depth = NULL, institutionCode = NULL, collectionCode = NULL, hasGeospatialIssue = NULL, issue = NULL, search = NULL, mediaType = NULL, subgenusKey = NULL, repatriated = NULL, phylumKey = NULL, kingdomKey = NULL, classKey = NULL, orderKey = NULL, familyKey = NULL, genusKey = NULL, establishmentMeans = NULL, protocol = NULL, license = NULL, organismId = NULL, publishingOrg = NULL, stateProvince = NULL, waterBody = NULL, locality = NULL, limit = 500, start = 0, fields = "all", return = "all", spellCheck = NULL, facet = NULL, facetMincount = NULL, facetMultiselect = NULL, skip_validate = TRUE, curlopts = list(), ...)


```{r}
# Taxon Key for Ambrosia intergradiens
key <- name_backbone(name='Ambrosia intergradiens')$speciesKey
# Country Code for Unites States
usa_code <- isocodes[grep("^United States$", isocodes$name), "code"]

occurrence_data <- occ_search(taxonKey=key, country=usa_code, hasCoordinate = TRUE, return='data')
head(occurrence_data)
```


```{r}
occurrence_data <- occ_search(scientificName = "Ambrosia intergradiens", country=usa_code, hasCoordinate = TRUE, return='data')
head(occurrence_data)
```


#### Get citation infomation for the datasets contributing to the occurence data.
```{r}
# Using the above occurence data of Ambrosia intergradiens in USA.
gbif_citation(occurrence_data)
```


#### browse photos
```{r eval=FALSE, include=FALSE}
# Country: United States (country code = US)
# Taxon: Ambrosia (taxonKey= 3110576)
media_data <- occ_search(taxonKey=3110576, country = "US", mediaType = 'StillImage', return = "media")
gbif_photos(media_data, which='table')
```



#### Download occurence data >500
In order to download large occurence records, you need to create a GBIF account.
Set user name, passward, email as objects.
```{r}
user <- "namiko"
pwd <- "735seibutsu"
email <- "nm0076@mix.wvu.edu"
```

1. Download preparation
You can choose a download format from DWCA(Darwin Core Archive), SIMPLE_CSV, and SPECIES_LIST.
```{r eval=FALSE, include=FALSE}
# Taxon: Genus Ambrosia, key = 3110576
# Country: USA, code = US
# Download format: Darwin Core Archive
dl_Ambrosia_USA <- occ_download('taxonKey = 3110576', 'country = US', format = "DWCA", user = user, pwd = pwd, email = email)
dl_Ambrosia_USA
```
<<gbif download>>
  Username: namiko
  E-mail: nm0076@mix.wvu.edu
  Format: DWCA
  Download key: 0009448-191105090559680

2. Save the data to your computer by using download key.
```{r}
dl_Ambrosia_USA <- "0009448-191105090559680"
data <- occ_download_get(key = dl_Ambrosia_USA, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
# Import
Ambrosia_USA <- occ_download_import(data)
head(Ambrosia_USA)
```



#### Plot occurence data on map
```{r}
library(ggplot2)
library(maps)
```

Example1:
Plot ragweed (Genus Ambrosia) distribution in USA by species. 
```{r}
usa <- map_data("usa")
ggplot(usa, aes(long, lat)) +
ggtitle("Species distribution of ragweed (Genus Ambrosia)") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = Ambrosia_USA, aes(decimalLongitude, decimalLatitude, color = specificEpithet), alpha=1, size = 1, show.legend = TRUE) +
coord_map(xlim = c(-130, -60), ylim = c(20, 50)) +
theme(legend.position="bottom", legend.box = "horizontal", legend.text  = element_text(size = 7), legend.key.size = unit(0.1, "lines"))
```

Example2:
Spread of Zika virus, plotted by year. 
```{r eval=FALSE, include=FALSE}
# Taxon: Genus Flavivirus (Zika virus), key = 9848767
# Download format: Darwin Core Archive
dl_ZikaVirus <- occ_download('taxonKey = 9848767', format = "DWCA", user = user, pwd = pwd, email = email)
```
```{r}
dl_ZikaVirus <- "0007974-191105090559680"
data <- occ_download_get(key = dl_ZikaVirus, path = "./", overwrite = TRUE,  curlopts = list(verbose=TRUE))
ZikaVirus_world <- occ_download_import(data)
```
```{r}
world <- map_data("world")
ggplot(world, aes(long, lat)) +
ggtitle("Spread of Zika virus -2019") +
geom_polygon(aes(group = group), fill = "white", 
              color = "black", size = .5) +
geom_jitter(data = ZikaVirus_world, aes(decimalLongitude, decimalLatitude, color = year), alpha=1, size = 3, show.legend = TRUE) +
scale_color_gradient(name="Year", low="blue", high="red")
```